# ==============================================================================
# Main CI Workflow
# ==============================================================================
# Comprehensive testing for Homeup dotfiles project
# ==============================================================================

name: CI

on:
  push:
    branches: [main]
    paths-ignore:
      - "**.md"
      - "LICENSE"
  pull_request:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Quality checks (fast)
  quality:
    name: Quality
    uses: ./.github/workflows/test-quality.yml
    secrets: inherit

  # Platform integration tests
  platforms:
    name: Platforms
    uses: ./.github/workflows/test-platforms.yml
    secrets: inherit

  # Summary
  summary:
    name: Summary
    runs-on: ubuntu-latest
    needs: [quality, platforms]
    if: always()

    steps:
      - name: Check Results
        run: |
          echo "=== CI Summary ==="
          echo ""
          echo "Quality:   ${{ needs.quality.result }}"
          echo "Platforms: ${{ needs.platforms.result }}"
          echo ""

          # Fail only if explicit failure or cancelled
          if [ "${{ needs.quality.result }}" == "failure" ] || \
             [ "${{ needs.platforms.result }}" == "failure" ] || \
             [ "${{ needs.quality.result }}" == "cancelled" ] || \
             [ "${{ needs.platforms.result }}" == "cancelled" ]; then
            echo "✗ Some tests failed or were cancelled"
            exit 1
          fi

          echo "✓ All tests passed (or skipped)"
