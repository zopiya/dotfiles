# ==============================================================================
# Justfile Validation & Testing
# ==============================================================================
# Tests justfile syntax, commands, and integration with chezmoi.
#
# Jobs:
#   - test-justfile: Justfile syntax and command validation
#   - test-integration: Just + Chezmoi integration testing
# ==============================================================================

name: Justfile Tests

on:
  workflow_call:
  workflow_dispatch:

# Limit concurrent runs per branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  HOMEBREW_NO_AUTO_UPDATE: 1
  HOMEBREW_NO_ANALYTICS: 1

jobs:
  # ----------------------------------------------------------------------------
  # Justfile Syntax & Commands
  # ----------------------------------------------------------------------------
  test-justfile:
    name: Justfile Commands
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Homebrew
        run: |
          /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
          echo "/home/linuxbrew/.linuxbrew/bin" >> $GITHUB_PATH
          eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"

      - name: Install Just
        run: |
          eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
          brew install just

      - name: Validate Justfile Syntax
        run: |
          eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
          echo "=== Validating Justfile Syntax ==="
          just --list > /dev/null || { echo "FAIL: Justfile syntax error"; exit 1; }
          echo "OK: Justfile syntax valid"

      - name: Test Help Commands
        run: |
          eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
          echo "=== Testing Help Commands ==="

          # Test help command
          echo "--- just help ---"
          just help || { echo "FAIL: just help"; exit 1; }

          # Test examples command
          echo "--- just examples ---"
          just examples || { echo "FAIL: just examples"; exit 1; }

          # Test shortcuts command
          echo "--- just shortcuts ---"
          just shortcuts || { echo "FAIL: just shortcuts"; exit 1; }

          echo "OK: All help commands work"

      - name: Test Package Verification
        run: |
          eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
          echo "=== Testing Package Verification ==="

          # Update Homebrew first
          echo "--- Updating Homebrew ---"
          brew update

          # Test packages-verify command
          echo "--- just packages-verify ---"
          just packages-verify || { echo "FAIL: packages-verify"; exit 1; }

          echo "OK: Package verification passed"

      - name: Test Duplicate Detection
        run: |
          eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
          echo "=== Testing Duplicate Detection ==="

          # Test packages-check-duplicates command
          echo "--- just packages-check-duplicates ---"
          just packages-check-duplicates || { echo "FAIL: packages-check-duplicates"; exit 1; }

          echo "OK: Duplicate detection passed"

      - name: Test Info Commands
        run: |
          eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
          echo "=== Testing Info Commands ==="

          # Test info command
          echo "--- just info ---"
          just info || { echo "FAIL: just info"; exit 1; }

          # Test packages-info command
          echo "--- just packages-info ---"
          just packages-info || { echo "FAIL: just packages-info"; exit 1; }

          # Test stats command
          echo "--- just stats ---"
          just stats || { echo "FAIL: just stats"; exit 1; }

          echo "OK: All info commands work"

      - name: Count Available Commands
        run: |
          eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
          echo "=== Counting Justfile Commands ==="

          command_count=$(just --list --unsorted | grep -c "^  " || true)
          echo "Total commands: $command_count"

          # We should have 80+ commands
          if [ "$command_count" -lt 80 ]; then
            echo "FAIL: Expected at least 80 commands, got $command_count"
            exit 1
          fi

          echo "OK: $command_count commands available"

  # ----------------------------------------------------------------------------
  # Just + Chezmoi Integration
  # ----------------------------------------------------------------------------
  test-integration:
    name: Just Integration
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Homebrew
        run: |
          /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
          echo "/home/linuxbrew/.linuxbrew/bin" >> $GITHUB_PATH
          eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"

      - name: Install Just & Chezmoi
        run: |
          eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
          brew install just chezmoi

      - name: Test Profile Commands
        run: |
          eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
          export HOMEUP_PROFILE=mini

          echo "=== Testing Profile Commands ==="

          # Test profile command
          echo "--- just profile ---"
          just profile || { echo "FAIL: just profile"; exit 1; }

          # Test profile-diff command
          echo "--- just profile-diff macos linux ---"
          just profile-diff macos linux || { echo "FAIL: just profile-diff"; exit 1; }

          echo "OK: Profile commands work"

      - name: Test Chezmoi Commands
        run: |
          eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
          export HOMEUP_PROFILE=mini

          echo "=== Testing Chezmoi Commands ==="

          # Test status command
          echo "--- just status ---"
          just status || { echo "FAIL: just status"; exit 1; }

          # Test data command
          echo "--- just data ---"
          just data || { echo "FAIL: just data"; exit 1; }

          echo "OK: Chezmoi commands work"

      - name: Test Validation Commands
        run: |
          eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"

          echo "=== Testing Validation Commands ==="

          # Test validate command
          echo "--- just validate ---"
          just validate || { echo "FAIL: just validate"; exit 1; }

          echo "OK: Validation commands work"
