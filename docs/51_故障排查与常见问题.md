# Troubleshooting and FAQ: Common Issues and Solutions

> Quick diagnosis and resolution guide for Homeup setup, configuration, and daily operations

**版本**: 1.0
**目标受众**: Homeup 用户、系统管理员、问题排查者
**前置知识**: Homeup 基础概念

---

## 目录

- [快速诊断](#快速诊断)
- [安装和初始化](#安装和初始化)
- [包管理](#包管理)
- [配置管理](#配置管理)
- [Git 和认证](#git-和认证)
- [编辑器](#编辑器)
- [Shell 环境](#shell-环境)
- [性能问题](#性能问题)
- [多机器同步](#多机器同步)

---

## 快速诊断

### 第一步：运行健康检查

```bash
# 最快的诊断方式
just doctor

# 如果没有 just
./justfile doctor

# 或直接运行 Chezmoi 检查
chezmoi status
```

输出应该显示：

```
=== Homeup Health Check ===

Required tools:
  [OK] brew
  [OK] chezmoi
  [OK] git
  [OK] just

Optional tools:
  [OK] zsh
  [OK] starship
  [--] mise (not installed)

All checks passed
```

### 常见诊断命令

```bash
# Homebrew 状态
brew doctor
brew outdated

# Chezmoi 状态
chezmoi status
chezmoi diff

# Git 状态
git status
git log --oneline -5

# Shell 启动时间
time zsh -i -c exit

# 版本检查
zsh --version
git --version
just --version
chezmoi --version
```

---

## 安装和初始化

### ❓ "brew command not found"

**问题**: Homebrew 未安装或不在 PATH 中

**诊断**:

```bash
# 检查是否安装
which brew

# 检查路径
echo $PATH

# 查看 Homebrew 位置
ls /opt/homebrew/bin/brew  # macOS
ls /home/linuxbrew/.linuxbrew/bin/brew  # Linux
```

**解决**:

```bash
# 安装 Homebrew
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

# 添加到 PATH（如果安装到非标准位置）
# 添加到 ~/.zshrc:
export PATH="/opt/homebrew/bin:$PATH"

# 重启 Shell
exec zsh -l
```

### ❓ "just bootstrap" 失败

**问题**: 初始化过程中断

**诊断**:

```bash
# 1. 检查前置条件
just check

# 2. 查看详细错误
just bootstrap --verbose  # 如果 just 支持

# 3. 逐步执行
just install-bootstrap
just install-core
just setup
```

**常见原因和解决**:

```bash
# 原因 1：Homebrew 没有足够权限
# 解决：
sudo chown -R $(whoami) /opt/homebrew

# 原因 2：网络问题
# 解决：
brew update
brew install --help  # 测试连接

# 原因 3：磁盘空间不足
# 诊断：
df -h

# 解决：
brew cleanup --prune=all
```

### ❓ "chezmoi init" 失败

**问题**: Chezmoi 初始化出错

**诊断**:

```bash
# 1. 检查 Homeup 仓库
git status

# 2. 检查 .chezmoi.toml.tmpl 是否存在
cat .chezmoi.toml.tmpl

# 3. 查看 Chezmoi 日志
:LspLog  # 在 Neovim 中
# 或
chezmoi init --help
```

**解决**:

```bash
# 1. 手动初始化
chezmoi init --source . --apply

# 2. 或指定 Profile
HOMEUP_PROFILE=macos chezmoi init --source . --apply

# 3. 如果还是失败，查看详细错误
chezmoi init --source . --dry-run

# 4. 清空并重试
chezmoi purge --force
chezmoi init --source . --apply
```

---

## 包管理

### ❓ "formula not found"

**问题**: `brew install nonexistent-package` 失败

**解决**:

```bash
# 1. 搜索正确的包名
brew search "package-keyword"

# 2. 查看包信息
brew info package-name

# 3. 检查是否已安装
brew list | grep package

# 4. 检查需要的 Tap
brew tap homebrew/cask
brew install --cask "app-name"
```

### ❓ "Permission denied" 在 brew 操作时

**问题**: Homebrew 权限问题

**解决**:

```bash
# 1. 修复权限
sudo chown -R $(whoami) /opt/homebrew

# 2. 或重新安装
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

# 3. 测试
brew list
```

### ❓ "Brewfile conflict"

**问题**: `brew bundle` 中有冲突的包

**诊断**:

```bash
# 运行 Homeup 的重复检查
just pkg-duplicates

# 输出应该显示冲突的包
```

**解决**:

```bash
# 1. 检查哪些包在两个 Brewfile 中
brew list

# 2. 移除重复
grep "package-name" packages/Brewfile.*

# 3. 从其中一个 Brewfile 中删除

# 4. 重试
just install
```

---

## 配置管理

### ❓ "chezmoi status" 显示变化，但我没有修改

**原因**: Chezmoi 检测到差异

**诊断**:

```bash
# 查看具体差异
chezmoi diff

# 查看文件权限问题
ls -la ~/.zshrc
```

**解决**:

```bash
# 原因 1：权限问题
# 修复：
chezmoi apply

# 原因 2：实际修改了
# 提交：
chezmoi add ~/.zshrc

# 原因 3：模板变量不匹配
# 查看：
chezmoi cat ~/.zshrc

# 修复：
# 更新 .chezmoi.toml.tmpl 中的变量
```

### ❓ "template syntax error"

**问题**: Chezmoi 模板出错

**诊断**:

```bash
# 1. 查看哪个文件有错误
git status

# 2. 检查模板语法
chezmoi execute-template < your-template-file

# 3. 运行验证
just validate
```

**解决**:

```bash
# 常见错误 1：未闭合的括号
# 错误：{{ .variable }
# 正确：{{ .variable }}

# 常见错误 2：无效的变量
# 检查：.chezmoi.toml.tmpl 中是否定义了该变量

# 常见错误 3：条件语法错误
# 错误：{{ if .variable }}
# 正确：{{- if .variable }}（-去掉空格）
```

---

## Git 和认证

### ❓ "ssh: connect refused"

**问题**: SSH 连接失败

**诊断**:

```bash
# 1. 测试 GitHub 连接
ssh -T git@github.com

# 2. 查看详细错误
ssh -v git@github.com

# 3. 检查 SSH 密钥
ls -la ~/.ssh/
```

**解决**:

```bash
# 原因 1：YubiKey 未加载
yk  # 加载 YubiKey
ssh-add -l  # 验证

# 原因 2：SSH 密钥权限
chmod 600 ~/.ssh/main

# 原因 3：SSH 配置错误
cat ~/.ssh/config
# 检查 IdentityFile 是否正确

# 原因 4：公钥未添加到 GitHub
# GitHub → Settings → SSH Keys → 添加新公钥
cat ~/.ssh/main.pub
```

### ❓ "git commit" 失败时出现 "gpg failed to sign"

**问题**: Git 签名失败

**诊断**:

```bash
# 1. 检查 Git 配置
git config user.signingkey
git config gpg.format

# 2. 测试签名
ssh-keygen -Y sign -f ~/.ssh/main <<< "test"

# 3. 检查 YubiKey
ssh-add -l
```

**解决**:

```bash
# 原因 1：YubiKey 未加载
yk  # 加载密钥

# 原因 2：签名密钥不正确
git config --global user.signingkey ~/.ssh/main

# 原因 3：SSH 程序路径错误
git config --global gpg.ssh.program /usr/bin/ssh-keygen

# 原因 4：allowed_signers 文件缺失
cat ~/.ssh/allowed_signers
# 如果不存在，创建：
echo "$USER sk-ssh-ed25519@... $(ssh-keygen -y -f ~/.ssh/main)" > ~/.ssh/allowed_signers
```

### ❓ "push rejected"

**问题**: 推送被远程拒绝

**原因和解决**:

```bash
# 原因 1：远程有你没有的提交
# 解决：
git pull --rebase
git push

# 原因 2：被保护的分支（main）
# 解决：
git checkout -b feature-branch
git push origin feature-branch
# 创建 Pull Request

# 原因 3：权限不足
# 检查：GitHub repository → Collaborators
# 或问主管添加你的访问权限
```

---

## 编辑器

### ❓ "Neovim won't open"

**问题**: `nvim` 命令无法启动

**诊断**:

```bash
# 1. 检查是否安装
which nvim
nvim --version

# 2. 检查配置
ls ~/.config/nvim/

# 3. 测试启动
nvim -u NONE  # 不加载配置
```

**解决**:

```bash
# 原因 1：Neovim 未安装
brew install neovim

# 原因 2：配置有语法错误
# 检查：
chezmoi apply  # 重新应用配置

# 原因 3：插件冲突
# 启动无配置 Neovim：
nvim -u NONE

# 然后检查配置文件中的错误
```

### ❓ "LSP not working"

**问题**: LSP 功能不可用

**诊断**:

```bash
# 在 Neovim 中：
:LspInfo

# 应该显示运行的语言服务器
```

**解决**:

```bash
# 原因 1：语言服务器未安装
:MasonInstall pyright

# 原因 2：语言服务器进程无响应
:LspRestart

# 原因 3：配置错误
# 检查：
cat ~/.config/nvim/lua/config/lsp.lua

# 重启 Neovim：
:q
nvim
```

---

## Shell 环境

### ❓ "zsh: command not found"

**问题**: 命令找不到

**诊断**:

```bash
# 1. 检查 command 是否安装
which command
brew list | grep command

# 2. 检查 PATH
echo $PATH

# 3. 检查 Shell 配置
cat ~/.zshrc
```

**解决**:

```bash
# 原因 1：包未安装
brew install command

# 原因 2：PATH 配置错误
# 添加到 ~/.zshrc：
export PATH="/opt/homebrew/bin:$PATH"

# 原因 3：Shell 配置冲突
# 检查重复定义或冲突的别名：
grep "alias command" ~/.zshrc ~/.config/zsh/*

# 删除冲突并重启：
exec zsh -l
```

### ❓ "Shell 启动缓慢"

**问题**: Zsh 初始化耗时太长

**诊断**:

```bash
# 测试启动时间
time zsh -i -c exit

# 应该 <100ms

# 查找慢的初始化代码
zsh -x  # 启用跟踪
# 逐行输出每个命令和耗时
Ctrl+C  # 停止
```

**解决**:

```bash
# 原因 1：插件过多
# 移除不必要的 Sheldon 插件
nvim ~/.config/sheldon/plugins.toml

# 原因 2：初始化代码冗长
# 简化 ~/.zshrc
# 移除调试代码、不必要的命令

# 原因 3：Mise 初始化缓慢
# 优化：
eval "$(mise activate zsh)"
# 而不是多次调用 mise
```

---

## 性能问题

### ❓ "Chezmoi apply 很慢"

**问题**: 应用配置耗时

**诊断**:

```bash
# 测试速度
time chezmoi apply

# 应该 <5 秒
```

**解决**:

```bash
# 原因 1：文件太多
# 检查有多少文件被管理：
chezmoi list | wc -l

# 原因 2：网络问题
# 如果使用 Git SSH：
git fetch

# 原因 3：磁盘性能
# 检查磁盘 I/O：
diskutil info /
```

### ❓ "Just 命令执行缓慢"

**问题**: `just` 任务耗时过长

**解决**:

```bash
# 原因 1：并行任务配置
# 检查 justfile 中是否使用 &&
# 改用 &：
command1 &
command2 &
wait

# 原因 2：Brew 操作缓慢
# 更新缓存：
brew update

# 原因 3：Chezmoi 集成
# 检查 chezmoi apply 的性能
time chezmoi apply
```

---

## 多机器同步

### ❓ "Pull 时出现冲突"

**问题**: `git pull` 后有合并冲突

**诊断**:

```bash
# 查看冲突文件
git status

# 查看具体冲突
git diff
```

**解决**:

```bash
# 原因 1：同时修改了同一文件
# 手动解决冲突：
nvim conflicted-file

# 删除冲突标记，保留需要的内容
# <<<<<< HEAD
# your changes
# ======
# incoming changes
# >>>>>>

# 2. 提交解决
git add conflicted-file
git commit -m "fix: merge conflict"

# 原因 2：Brewfile 冲突
# 解决：
just pkg-duplicates  # 检查重复包
# 移除重复，保留两边的更改
```

### ❓ "新机器无法 Clone Homeup 仓库"

**问题**: SSH 认证失败

**诊断**:

```bash
# 1. 测试 SSH
ssh -T git@github.com

# 2. 测试 clone
git clone git@github.com:username/homeup.git

# 3. 查看错误信息
# 通常会显示权限或网络问题
```

**解决**:

```bash
# 原因 1：SSH 密钥未设置
# 生成密钥：
ssh-keygen -t ed25519 -C "user@example.com"

# 原因 2：SSH 密钥未添加到 GitHub
# 复制公钥：
cat ~/.ssh/id_ed25519.pub
# GitHub → Settings → SSH Keys → New SSH Key

# 原因 3：YubiKey 未加载
yk
ssh-add -l  # 验证

# 原因 4：网络问题
# 检查连接：
ping github.com

# 使用 HTTPS 作为备选：
git clone https://github.com/username/homeup.git
```

---

## 快速参考

### 常见命令速查

```bash
# 诊断和修复
just doctor          # 健康检查
just validate-all    # 快速验证
chezmoi diff         # 查看待应用的更改
chezmoi apply        # 应用配置

# 问题排查
git status           # 看工作状态
git log --oneline    # 看提交历史
zsh --version        # 看 shell 版本
just --version       # 看 just 版本

# 紧急修复
just rescue          # 紧急修复
chezmoi purge --force # 清除所有 Chezmoi 状态
brew cleanup         # 清除 Brew 缓存
```

---

## 何时寻求帮助

### 收集调试信息

在报告问题时，提供以下信息：

```bash
# 系统信息
uname -a
arch

# 工具版本
zsh --version
git --version
just --version
chezmoi --version
brew --version

# 错误日志
# 运行失败的命令并复制输出

# 配置检查
chezmoi status
git status
just doctor

# 如果涉及 LSP
:LspInfo        # 在 Neovim 中
```

---

## 参考资源

- [Homeup GitHub Issues](https://github.com/yourusername/homeup/issues)
- [Chezmoi 故障排查](https://www.chezmoi.io/reference/troubleshooting/)
- [Homebrew 常见问题](https://docs.brew.sh/Troubleshooting)
- [Just GitHub Issues](https://github.com/casey/just/issues)
- [Zsh FAQ](http://zsh.sourceforge.net/FAQ/)
