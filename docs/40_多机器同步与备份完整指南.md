# Multi-Machine Sync and Backup Complete Guide: Unified Configuration Across Devices

> Seamlessly sync dotfiles, environment configs, and settings across MacBook, Linux servers, and Codespaces

**版本**: 1.0
**目标受众**: 多机器用户、DevOps 工程师、远程开发者、技术主管
**前置知识**: Homeup 基础、Git 基础、SSH 基础

---

## 目录

- [核心概念](#核心概念)
- [架构设计](#架构设计)
- [快速开始](#快速开始)
- [同步工作流](#同步工作流)
- [完整场景](#完整场景)
- [备份策略](#备份策略)
- [冲突解决](#冲突解决)
- [常见问题](#常见问题)
- [总结与最佳实践](#总结与最佳实践)

---

## 核心概念

### 多机器的挑战

```
MacBook（个人开发机）
├─ 完整 Homeup 配置
├─ 所有 GUI 应用
├─ YubiKey 密钥
└─ 本地数据库

Linux Server（远程工作）
├─ 轻量级 Homeup（core only）
├─ 无 GUI
├─ SSH 代理转发
└─ 生产环境配置

Codespaces（容器开发）
├─ 最小化 bootstrap
├─ 临时环境
└─ 云端编辑
```

**需要同步的内容**:

```
✅ Dotfiles (.zshrc, .config/nvim, .ssh/config)
✅ 环境配置 (Mise, Direnv)
✅ Git 配置 (SSH 签名密钥、用户信息)
✅ 编辑器设置 (Neovim、VS Code)
❌ 不同步的：数据、大文件、敏感密钥
```

### 同步模型

```
┌──────────────────┐
│   GitHub Repo    │ (Homeup)
│  - Chezmoi       │
│  - Brewfiles     │
│  - Configs       │
└────────┬─────────┘
         │
    ┌────┼────┐
    │    │    │
 ┌──▼──┐ │ ┌──▼──┐
 │MacOS│ │ │Linux│
 └─────┘ │ └─────┘
    ┌────▼──┐
    │Codespace│
    └─────────┘

所有机器→拉取→应用→一致配置
```

---

## 架构设计

### 四层同步架构

```
Layer 1: Core Dotfiles (Chezmoi)
  ├─ ~/.zshrc, ~/.zshenv
  ├─ ~/.config/git/config
  ├─ ~/.config/nvim/
  ├─ ~/.ssh/config
  └─ 平台无关，版本控制

Layer 2: Environment (Mise + Direnv)
  ├─ ~/.config/mise/config.toml
  ├─ ~/.envrc
  └─ 项目级 .mise.toml、.envrc

Layer 3: Editor Configuration
  ├─ VS Code Settings Sync
  ├─ Neovim 配置（已在 Layer 1）
  └─ 快捷键和扩展

Layer 4: Machine-Specific
  ├─ 机器名称、IP 地址
  ├─ 本地数据库连接
  ├─ 机密信息（.env.local）
  └─ 不版本控制
```

### 文件分类

```
版本控制的（Homeup）:
✅ dot_zshrc, dot_config/
✅ Shell 脚本和函数
✅ 模板文件 (.tmpl)
✅ 配置示例 (.example)

不版本控制的（在 .gitignore）:
❌ .env.local（机器特定密钥）
❌ .env.*.local（个人凭证）
❌ SSH 私钥（存储在 YubiKey）
❌ 大文件（数据库、日志）
```

---

## 快速开始

### ⚡ 新机器 5 分钟快速初始化

#### macOS

```bash
# 1. 安装 Homebrew
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

# 2. 克隆 Homeup
git clone https://github.com/yourusername/homeup.git
cd homeup

# 3. 一键初始化
just bootstrap
# 这会：
# ✅ 检查前置条件（5 秒）
# ✅ 安装所有包（10-15 分钟）
# ✅ 配置环境（2 分钟）
# ✅ 应用 dotfiles（1 分钟）

# 4. 重启 Shell
exec zsh -l

# 5. 验证
just doctor
```

#### Linux Server

```bash
# 1. 安装 Homebrew（如果没有）
curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh | bash

# 2. 克隆 Homeup
git clone https://github.com/yourusername/homeup.git
cd homeup

# 3. 仅安装 core（不装 macOS 特定工具）
export HOMEUP_PROFILE=linux
just install-core

# 4. 应用配置
just apply

# 5. 加载 SSH 代理
eval "$(ssh-agent)"
ssh-add -K  # 加载 YubiKey（如果可用）
```

#### Codespaces

```bash
# 1. Codespaces 自动加载默认配置
# 2. 克隆 Homeup
git clone https://github.com/yourusername/homeup.git
cd homeup

# 3. 安装最少依赖
just install-bootstrap

# 4. 应用 dotfiles
chezmoi init --source . --apply

# 5. 使用
# Codespaces 提供了 VS Code Web 界面
```

---

## 同步工作流

### 工作流 1：在 MacBook 修改，同步到 Linux

```bash
# 1️⃣ 在 MacBook 上修改配置
# 修改 ~/.zshrc
nvim ~/.zshrc

# 2️⃣ 告诉 Chezmoi 管理修改
chezmoi add ~/.zshrc

# 3️⃣ 检查变化
chezmoi diff

# 4️⃣ 提交到 Git
git -C ~/.local/share/chezmoi add -A
git -C ~/.local/share/chezmoi commit -m "feat: update zsh config"
git -C ~/.local/share/chezmoi push

# 5️⃣ 在 Linux 上同步
ssh linux-server
cd ~/homeup
git pull
chezmoi update  # pull + apply
```

**验证**:

```bash
# 在 Linux 上查看同步后的配置
cat ~/.zshrc

# 应该与 MacBook 上的相同
# ✅ 同步成功
```

### 工作流 2：Mise 版本配置同步

```bash
# 场景：在 MacBook 升级 Python，需要在 Linux 和 Codespaces 同步

# 1️⃣ 在 MacBook 修改
# ~/.config/mise/config.toml
[tools]
python = "3.12"  # 升级到 3.12

mise install  # 安装 Python 3.12

# 2️⃣ 提交到 Homeup
git add ~/.config/mise/config.toml
git commit -m "feat: upgrade python to 3.12"
git push

# 3️⃣ 在 Linux 上应用
git pull
mise install -y

# 4️⃣ 验证
python --version
# 输出: Python 3.12.x
```

### 工作流 3：VS Code 设置跨机器同步

```bash
# 方法 1：Settings Sync（推荐）
# 在所有机器上：
# 1. Cmd+Shift+P → "Sync: Turn On"
# 2. 登录 GitHub
# 3. 自动同步所有设置、扩展、快捷键

# 方法 2：Chezmoi 备份（备选）
# 在 MacBook 导出 VS Code 配置
mkdir -p ~/.config/Code/User
cp ~/Library/Application\ Support/Code/User/settings.json ~/.config/Code/User/

# 提交到 Homeup
git add ~/.config/Code/User/
git commit -m "feat: sync VS Code settings"
git push

# 在 Linux 或 Codespaces 恢复
chezmoi apply
# 会将 VS Code 设置恢复到标准位置
```

---

## 完整场景

### 场景：全公司团队设置

#### 初始设置

```bash
# 团队主管在 MacBook 上配置
just bootstrap

# 创建团队优化的 Homeup
git clone git@github.com:company/homeup.git

# 自定义配置
# - 添加公司 Git 配置（用户名、邮箱）
# - 配置公司代理
# - 添加必需的 Homebrew 包

git commit -m "feat: company-specific homeup setup"
git push

# 分享给全队
# 发送 Homeup 仓库链接
```

#### 开发人员初始化

```bash
# 每个开发人员
git clone https://github.com/company/homeup.git
cd homeup

# MacBook
just bootstrap

# Linux 开发服务器
export HOMEUP_PROFILE=linux
just install

# 验证
just doctor
```

#### 日常协作

```bash
# 主管添加新工具到 Homeup
# 1. 添加到 Brewfile.core
# 2. 提交并推送
# 3. 测试（just validate-all）

# 开发人员同步
git pull
just install

# ✅ 所有开发人员拥有相同的工具
```

---

## 备份策略

### 关键数据备份

```
定期备份的：
✅ GitHub Repo (Homeup)
  - Dotfiles
  - Brewfiles
  - 配置

✅ SSH 公钥（导出）
  - ~/.ssh/main.pub
  - ~/.ssh/back.pub

✅ YubiKey（硬件本身是备份）
  - 主 YubiKey
  - 备用 YubiKey

不需要备份的：
❌ ~/.ssh/main（私钥在 YubiKey 中）
❌ node_modules/、.venv/（可重新生成）
❌ ~/Library/Caches/（缓存）
```

### 完整机器备份

```bash
# 备份关键文件（不备份数据）
tar -czf ~/backups/homeup-config-backup.tar.gz \
  ~/.config/nvim \
  ~/.config/git \
  ~/.config/zsh \
  ~/.config/mise \
  ~/.ssh/*.pub

# 上传到安全位置（不是云盘）
scp ~/backups/homeup-config-backup.tar.gz \
  backup-server:/secure/backups/
```

### 恢复流程

```bash
# 新机器恢复
# 1. 安装 Homebrew
# 2. 克隆 Homeup
# 3. 运行 just bootstrap
# 4. 从备份恢复私钥或 YubiKey

# 验证恢复
just doctor
git status
ssh -T github.com
```

---

## 冲突解决

### 场景 1：同时修改同一个文件

```bash
# MacBook 修改 ~/.zshrc
# Linux 也修改 ~/.zshrc

# MacBook 先 push
git push

# Linux pull 时出现冲突
git pull
# Error: merging is not possible because of uncommitted changes

# 解决：
git add ~/.zshrc
git commit -m "refactor: update zsh config"
# 可能会提示冲突，需要手动解决
# 编辑文件，选择保留的部分
git add ~/.zshrc
git commit -m "fix: merge conflict in zshrc"
git push
```

**最佳实践**: 沟通协调，避免同时修改同一个文件

### 场景 2：Brewfile 冲突

```bash
# MacBook 添加新包
# Linux 也添加新包
# 合并时可能有冲突

# 手动解决
git diff Brewfile.core

# 保留两边的更改
# 确保没有重复包
just pkg-duplicates

# 提交解决
git add Brewfile.core
git commit -m "fix: merge brewfile updates"
```

### 场景 3：敏感信息冲突

```bash
# 如果 .env.local 被意外提交
# （应该在 .gitignore 中）

# 立即删除
git rm --cached .env.local
git commit -m "fix: remove sensitive data"
git push

# 通知团队修改密码/密钥
# 遵循故障响应流程
```

---

## 常见问题

### ❓ 如何在没有互联网的机器上初始化？

**答**:

```bash
# 预先准备：
# 1. 在有网络的机器上下载 Homeup
git clone https://github.com/yourusername/homeup.git

# 2. 下载 Homebrew 包缓存
brew bundle --file=Brewfile.core --dry-run

# 3. 打包整个 Homeup
tar -czf homeup-offline.tar.gz homeup/

# 4. 在离线机器上
tar -xzf homeup-offline.tar.gz
cd homeup

# 5. 使用本地包（如果有的话）
# 或等待有网络后执行 just bootstrap
```

### ❓ 如何管理多个 GitHub 账户？

**答**:

```bash
# ~/.ssh/config - 多个 SSH 密钥

Host github-personal
    HostName github.com
    User git
    IdentityFile ~/.ssh/personal-main

Host github-work
    HostName github.com
    User git
    IdentityFile ~/.ssh/work-main

# Git 配置
# 对不同的仓库使用不同的身份

# Personal repo
git config user.email personal@gmail.com
git config user.signingkey ~/.ssh/personal-main

# Work repo
git config user.email work@company.com
git config user.signingkey ~/.ssh/work-main
```

### ❓ Codespaces 上的 Homeup 如何同步？

**答**:

```bash
# Codespaces devcontainer.json 配置
{
  "image": "mcr.microsoft.com/devcontainers/base:ubuntu",
  "postCreateCommand": "cd /workspace && git clone https://github.com/yourusername/homeup.git && cd homeup && just install-bootstrap"
}

# 这样每个 Codespace 都会自动初始化 Homeup
```

---

## 总结与最佳实践

| 方面 | 最佳实践 |
|------|---------|
| **同步频率** | 每天同步（pull + apply）|
| **提交频率** | 每周提交配置更改 |
| **备份** | 备份公钥和恢复步骤（不备份私钥） |
| **测试** | 在新机器上测试 Homeup 配置 |
| **文档** | 记录机器特定的配置 |
| **安全** | 敏感信息用 .env.local 或 Chezmoi 模板 |
| **冲突** | 提前沟通，避免同时修改 |

### 核心命令速查

```bash
# 初始化新机器
git clone https://github.com/yourusername/homeup.git
cd homeup
just bootstrap

# 日常同步
git pull
chezmoi update

# 修改配置
chezmoi add ~/.zshrc
git -C ~/.local/share/chezmoi add -A
git -C ~/.local/share/chezmoi commit -m "msg"
git -C ~/.local/share/chezmoi push

# 验证
just doctor
just validate-all
```

---

## 参考资源

- [Homeup 项目](https://github.com/yourusername/homeup)
- [Chezmoi 多机器指南](CHEZMOI_COMPLETE_GUIDE.md)
- [Mise 版本管理](MISE_GUIDE.md)
- [Direnv 环境管理](DIRENV_COMPLETE_GUIDE.md)
- [Git SSH 签名](GIT_SSH_SIGNING_COMPLETE_GUIDE.md)
- [YubiKey 设置](YUBIKEY_FIDO2_SSH_GUIDE.md)
- [VS Code 同步](VS_CODE_PROFILES_GUIDE.md)
- [Architecture Design](architecture.md)
