#!/usr/bin/env bash

# Purpose: Install GUI applications
# Runs once when hash changes

{{ template "utils.sh" . -}}

{{ if not (get . "install_gui") -}}
info "Skipping GUI applications installation"
exit 0
{{ end -}}

set -eu
set -o pipefail

header "Installing GUI Applications"

{{ if eq .chezmoi.os "linux" -}}
# Install Flatpak if not present
step 1 3 "Checking Flatpak..."
if ! command -v flatpak &> /dev/null; then
    info "Installing Flatpak..."
    
    SUDO=""
    if command -v sudo &> /dev/null; then
        SUDO="sudo"
    elif [ "$EUID" -ne 0 ]; then
        error "Root privileges required to install Flatpak."
        exit 1
    fi

    if command -v apt-get &> /dev/null; then
        $SUDO apt-get install -y flatpak
    elif command -v dnf &> /dev/null; then
        $SUDO dnf install -y flatpak
    fi
    success "Flatpak installed"
else
    success "Flatpak already installed"
fi

# Add Flathub repo
step 2 3 "Adding Flathub repository..."
flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
success "Flathub added"

# Install Flatpak apps
step 3 3 "Installing applications..."
apps=(
    "com.visualstudio.code"
    "com.google.Chrome"
    "com.1password.1password"
)

for app in "${apps[@]}"; do
    flatpak install -y flathub "$app" > /dev/null 2>&1 &
    spinner $! "Installing $app..."
done
success "Applications installed"
{{ end -}}

echo ""
success "GUI setup complete"
