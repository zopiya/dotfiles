#!/usr/bin/env bash
set -eu
set -o pipefail

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ðŸ“¦ Installing Selected Packages"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# æ˜¾ç¤ºå°†è¦å®‰è£…çš„ç±»åˆ«
echo "Categories selected:"
{{ if (get . "install_core_cli") -}}
echo "  âœ“ Core CLI Tools"
{{ end -}}
{{ if (get . "install_fonts") -}}
echo "  âœ“ Fonts"
{{ end -}}
{{ if (get . "install_security") -}}
echo "  âœ“ Security Tools"
{{ end -}}
{{ if (get . "install_gui") -}}
echo "  âœ“ GUI Applications"
{{ end -}}
{{ if (get . "install_mise") -}}
echo "  âœ“ Development Runtimes"
{{ end -}}
{{ if (get . "install_maintenance") -}}
echo "  âœ“ Maintenance Tools"
{{ end -}}

echo ""
echo "â³ Installing via Homebrew..."

# Homebrew Configuration
if [[ -x /opt/homebrew/bin/brew ]]; then
  eval "$(/opt/homebrew/bin/brew shellenv)"
elif [[ -x /usr/local/bin/brew ]]; then
  eval "$(/usr/local/bin/brew shellenv)"
elif [[ -x /home/linuxbrew/.linuxbrew/bin/brew ]]; then
  eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
elif [[ -x "$HOME/.linuxbrew/bin/brew" ]]; then
  eval "$("$HOME/.linuxbrew/bin/brew" shellenv)"
fi

# Render Brewfile to a temporary location
BREWFILE=$(mktemp -t brewfile.XXXXXX 2>/dev/null || mktemp)
trap 'rm -f "$BREWFILE"' EXIT

# Use chezmoi execute-template to render the Brewfile
# We read the template file from the source directory
chezmoi execute-template < "{{ .chezmoi.sourceDir }}/data/Brewfile.tmpl" > "$BREWFILE"

# Execute installation
brew bundle --file="$BREWFILE"

echo ""
echo "âœ… Installation complete!"
